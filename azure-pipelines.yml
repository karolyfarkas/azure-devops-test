trigger:
- mainfr

resources:
      repositories:
      - repository: hello-deploy
        type: github
        endpoint: karolyfarkas-github
        name: karolyfarkas/hello-deploy

stages:
  - stage: Build
    jobs:
      - job: Build
        pool:
          vmImage: ubuntu-latest
        steps:
          - task: Bash@3
            displayName: 'Troubleshooting...'
            inputs:
              targetType: 'inline'
              script: 'ls'
          - task: Bash@3
            displayName: 'Get version number from VERSION file'
            inputs:
              targetType: 'inline'
              script: 'echo "##vso[build.updatebuildnumber]$(cat VERSION)-$(Build.BuildId)"'
          - task: Bash@3
            displayName: 'Build application'
            inputs:
              targetType: 'inline'
              script: |      
                echo 'Building the application.... bip.. bop...'
          - task: Docker@2
            displayName: 'Build docker image'
            inputs:
              containerRegistry: 'google-artifact-registry'
              repository: 'farkasret/test/hello'
              command: 'buildAndPush'
              Dockerfile: 'Dockerfile'
              tags: '$(Build.BuildNumber)'
              addPipelineData: false
            
  - stage: Test
    dependsOn: Build
    jobs:
      - job: Test
        pool:
          vmImage: ubuntu-latest
        steps:
        - checkout: hello-deploy
          persistCredentials: true
        - script: npm install typed-rest-client --save 
          displayName: Azure DevOps Patch Install missing packages for ContainerStructureTest
        - task: ContainerStructureTest@0
          inputs:
            dockerRegistryServiceConnection: 'google-artifact-registry'
            repository: 'farkasret/test/hello'
            tag: '$(Build.BuildNumber)'
            configFile: 'cst-config.yaml'
            testRunTitle: 'CST'
            failTaskOnFailedTests: true 
        - task: Bash@3
          displayName: 'Testing'
          inputs:
            targetType: 'inline'
            script: 'echo Testing....1....2...1...2....'

  - stage: Deploy
    dependsOn: Test
    jobs:
      - deployment:
        pool:
          vmImage: ubuntu-latest
        environment: 'Dev'
        strategy:
         runOnce:
           deploy:
             steps:
              - checkout: hello-deploy
                persistCredentials: true
              - task: Bash@3
                displayName: 'Troubleshooting...'
                inputs:
                  targetType: 'inline'
                  script: 'ls'
              - task: Bash@3
                displayName: 'Change version number in helm chart'
                inputs:
                  targetType: 'inline'
                  script: |
                    git config user.email azure-pipelines@aka.ms
                    git config user.name azure-pipelines
                    git checkout main
                    sed -i 's|appVersion:.*|appVersion: "$(Build.BuildNumber)"|' helm-chart/Chart.yaml
                    git add helm-chart/Chart.yaml
                    git commit -am 'autorelease by pipeline'
                    git push
              - task: HelmInstaller@0
                inputs:
                  helmVersion: '2.14.1'
                  installKubectl: true
              - task: HelmDeploy@0
                inputs:
                  connectionType: 'Kubernetes Service Connection'
                  kubernetesServiceConnection: 'gke-test-cluster'
                  namespace: 'default'
                  command: 'upgrade'
                  chartType: 'Name'
                  chartName: 'helm-chart'
                  releaseName: 'hello'